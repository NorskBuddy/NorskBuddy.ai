<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Norsk Buddy</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin:0;
  font-family:system-ui,sans-serif;
  background:linear-gradient(135deg,#1cb0f6,#58cc02);
}
body.jp {
  background:linear-gradient(135deg,#f472b6,#fb7185);
}
.app {
  max-width:480px;
  margin:auto;
  background:#fff;
  min-height:100vh;
  padding:20px;
}
h1,h2 { text-align:center; }

.lang-toggle {
  display:flex;
  justify-content:center;
  gap:12px;
  margin-bottom:8px;
  font-size:28px;
  cursor:pointer;
}
.lang-toggle span { opacity:.4; }
.lang-toggle .active { opacity:1; }

.section {
  background:#f0f8ff;
  border-radius:16px;
  padding:14px;
  margin-top:16px;
}
body.jp .section { background:#fff1f5; }

.section-header {
  font-size:18px;
  font-weight:bold;
  cursor:pointer;
}
.hidden { display:none; }

.lesson-grid {
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:12px;
  margin-top:12px;
}
.lesson {
  background:#fff;
  border-radius:12px;
  padding:14px;
  text-align:center;
  cursor:pointer;
  box-shadow:0 2px 4px rgba(0,0,0,.1);
}

.bubbles {
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:16px;
}
.bubble {
  background:#e0e0e0;
  padding:8px 12px;
  border-radius:20px;
  cursor:pointer;
}
.bubble.selected { background:#58cc02; color:#fff; }
body.jp .bubble.selected { background:#ec4899; }
.bubble.wrong { background:#ff6b6b; color:#fff; }

.answer-line {
  min-height:40px;
  border-bottom:2px solid #ccc;
  margin-top:12px;
  padding:6px;
}

.stats {
  display:flex;
  justify-content:space-between;
  margin-bottom:10px;
  font-size:14px;
}

/* NEW ADDITIONS */
.tapword {
  cursor:pointer;
  border-bottom:1px dotted #999;
}
.tapword:hover { opacity:.7; }

.match-grid {
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:10px;
  margin-top:15px;
}
.match-card {
  background:#f0f0f0;
  padding:12px;
  border-radius:12px;
  text-align:center;
  cursor:pointer;
}
.match-card.selected { background:#58cc02; color:#fff; }
body.jp .match-card.selected { background:#ec4899; }
</style>
</head>

<body>
<div class="app">

<div class="lang-toggle">
  <span id="flagNO" class="active">üá≥üá¥</span>
  <span id="flagJP">üáØüáµ</span>
</div>

<h1 id="title">Norsk Buddy</h1>

<div class="stats">
  <div>üî• Streak: <span id="streakEl">0</span></div>
  <div>‚≠ê XP: <span id="xpEl">0</span> (Lv <span id="levelEl">1</span>)</div>
</div>

<div id="home">
  <div class="section">
    <div class="section-header" onclick="toggle('sec1')">Section 1 ‚Äì The Basics</div>
    <div id="sec1" class="hidden"><div class="lesson-grid" id="sec1grid"></div></div>
  </div>

  <div class="section">
    <div class="section-header" onclick="toggle('sec2')">Section 2 ‚Äì Building Confidence</div>
    <div id="sec2" class="hidden"><div class="lesson-grid" id="sec2grid"></div></div>
  </div>

  <div class="section">
    <div class="section-header" onclick="toggle('sec3')">Section 3 ‚Äì Everyday Fluency</div>
    <div id="sec3" class="hidden"><div class="lesson-grid" id="sec3grid"></div></div>
  </div>

  <div class="section">
    <div class="section-header" onclick="startMatch(false)">Match Madness ‚Äì Unlimited</div>
  </div>

  <div class="section">
    <div class="section-header" onclick="startMatch(true)">Match Madness ‚Äì 1:30 Timed</div>
  </div>
</div>

<div id="lessonView" class="hidden">
  <button onclick="goHome()">‚Üê Back</button>
  <h2 id="lessonTitle"></h2>
  <p id="example"></p>
  <button onclick="playAudio()">üîä Play Audio</button>
  <div class="answer-line" id="answerLine"></div>
  <div class="bubbles" id="bubbles"></div>
</div>

<div id="matchView" class="hidden">
  <button onclick="exitMatch()">‚Üê Back</button>
  <h2>Match Madness</h2>
  <div id="matchTimer"></div>
  <div class="match-grid" id="matchGrid"></div>
</div>

</div>

<script>

/* ORIGINAL DATA + ROMAJI SUPPORT */

let lessons;
let speechLang="no-NO";

const lessonsNO = { ... }  // KEEP YOUR ORIGINAL OBJECT HERE (UNCHANGED)

/* JAPANESE WITH ROMAJI */
const lessonsJP = {
  sec1: lessonsNO.sec1.map(l=>({
    title:l.title,
    sentence:{ romaji:"watashi wa gakusei desu", kanji:"ÁßÅ„ÅØÂ≠¶Áîü„Åß„Åô" },
    translation:l.translation
  })),
  sec2: lessonsNO.sec2.map(l=>({
    title:l.title,
    sentence:{ romaji:"watashi wa kyo hataraite imasu", kanji:"ÁßÅ„ÅØ‰ªäÊó•ÂÉç„ÅÑ„Å¶„ÅÑ„Åæ„Åô" },
    translation:l.translation
  })),
  sec3: lessonsNO.sec3.map(l=>({
    title:l.title,
    sentence:{ romaji:"watashi wa eiga o mite imasu", kanji:"ÁßÅ„ÅØÊò†Áîª„ÇíË¶ã„Å¶„ÅÑ„Åæ„Åô" },
    translation:l.translation
  }))
};

lessons = lessonsNO;

/* CORE ENGINE (ORIGINAL + ENHANCED) */

let xp=0;
let streak=parseInt(localStorage.getItem("streak")||0);
let level=1;
let current=null;
let selected=[];

let lastVisit = localStorage.getItem("lastVisit");
let today = new Date().toDateString();

function buildAll(){
  ["sec1","sec2","sec3"].forEach(sec=>{
    document.getElementById(sec+"grid").innerHTML="";
    lessons[sec].forEach((l,i)=>{
      const d=document.createElement("div");
      d.className="lesson";
      d.textContent=l.title;
      d.onclick=()=>startLesson(sec,i);
      document.getElementById(sec+"grid").appendChild(d);
    });
  });
}

function makeClickable(text){
  return text.split(" ").map(w=>
    `<span class="tapword" onclick="alert('Definition for: '+ '${w}')">${w}</span>`
  ).join(" ");
}

function startLesson(sec,i){
  current=lessons[sec][i];
  lessonTitle.textContent=current.title;
  selected=[];

  if(typeof current.sentence==="object"){
    example.innerHTML=
      `<div>${makeClickable(current.sentence.romaji)}</div>
       <div style="opacity:.7">${makeClickable(current.sentence.kanji)}</div>`;
  } else {
    example.innerHTML=makeClickable(current.sentence);
  }

  renderBubbles();
  home.classList.add("hidden");
  lessonView.classList.remove("hidden");
}

function renderBubbles(){
  const words=current.translation.split(" ");
  const pool=[...words];
  while(pool.length<words.length+3) pool.push(randomWord());
  shuffle(pool);

  bubbles.innerHTML="";
  answerLine.textContent="";

  pool.forEach(w=>{
    const s=document.createElement("span");
    s.className="bubble";
    s.textContent=w;
    s.onclick=()=>toggleWord(s,w);
    bubbles.appendChild(s);
  });
}

function toggleWord(el,w){
  if(el.classList.contains("selected")){
    el.classList.remove("selected");
    selected=selected.filter(x=>x!==w);
  } else {
    el.classList.add("selected");
    selected.push(w);
  }
  answerLine.textContent=selected.join(" ");
  if(selected.join(" ")===current.translation){
    xp+=10;

    if(lastVisit!==today){
      streak++;
      localStorage.setItem("lastVisit",today);
    }

    localStorage.setItem("streak",streak);
    updateStats();
    setTimeout(goHome,500);
  }
}

function playAudio(){
  let text = typeof current.sentence==="object"
    ? current.sentence.romaji
    : current.sentence;

  let fileName=text
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g,"")
    .replace(/\s+/g,"_")
    .toLowerCase();

  let folder = speechLang==="ja-JP"
    ? "Norsk-Buddy-Audio/Japanese/"
    : "Norsk-Buddy-Audio/";

  let audio=new Audio(folder+fileName+".mp3");

  audio.onerror=function(){
    const u=new SpeechSynthesisUtterance(text);
    u.lang=speechLang;
    speechSynthesis.speak(u);
  };

  audio.play();
}

function goHome(){
  home.classList.remove("hidden");
  lessonView.classList.add("hidden");
}

function toggle(id){ document.getElementById(id).classList.toggle("hidden"); }
function randomWord(){ return ["I","you","he","she","we","they","am","are"][Math.random()*8|0]; }
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.random()*(i+1)|0;[a[i],a[j]]=[a[j],a[i]]}}

function updateStats(){
  xpEl.textContent=xp;
  streakEl.textContent=streak;
  levelEl.textContent=Math.floor(xp/100)+1;
}

/* MATCH MADNESS */

let matchPairs=[], matchSelected=[], matchTimerInt;

function startMatch(timed){
  home.classList.add("hidden");
  matchView.classList.remove("hidden");

  matchPairs=[];
  lessons.sec1.slice(0,5).forEach(l=>{
    matchPairs.push({q:l.sentence, a:l.translation});
  });

  buildMatch();

  if(timed){
    let t=90;
    matchTimer.textContent="1:30";
    matchTimerInt=setInterval(()=>{
      t--;
      let m=Math.floor(t/60);
      let s=t%60;
      matchTimer.textContent=m+":"+(s<10?"0"+s:s);
      if(t<=0){ clearInterval(matchTimerInt); exitMatch(); }
    },1000);
  } else {
    matchTimer.textContent="Unlimited Mode";
  }
}

function buildMatch(){
  matchGrid.innerHTML="";
  let cards=[];
  matchPairs.forEach(p=>{
    cards.push({v: typeof p.q==="object"?p.q.romaji:p.q, t:"q"});
    cards.push({v:p.a, t:"a"});
  });
  shuffle(cards);
  cards.forEach(c=>{
    const d=document.createElement("div");
    d.className="match-card";
    d.textContent=c.v;
    d.onclick=()=>selectMatch(d,c);
    matchGrid.appendChild(d);
  });
}

function selectMatch(el,c){
  el.classList.add("selected");
  matchSelected.push({el,c});
  if(matchSelected.length===2){
    const [a,b]=matchSelected;
    if(a.c.v!==b.c.v){
      xp+=5;
      updateStats();
      setTimeout(()=>{a.el.remove();b.el.remove();},300);
    } else {
      setTimeout(()=>{
        a.el.classList.remove("selected");
        b.el.classList.remove("selected");
      },500);
    }
    matchSelected=[];
  }
}

function exitMatch(){
  clearInterval(matchTimerInt);
  matchView.classList.add("hidden");
  home.classList.remove("hidden");
}

/* LANGUAGE TOGGLE */

flagNO.onclick=()=>{
  lessons=lessonsNO;
  speechLang="no-NO";
  document.body.classList.remove("jp");
  title.textContent="Norsk Buddy";
  flagNO.classList.add("active");
  flagJP.classList.remove("active");
  buildAll();
};

flagJP.onclick=()=>{
  lessons=lessonsJP;
  speechLang="ja-JP";
  document.body.classList.add("jp");
  title.textContent="Êó•Êú¨Ë™û Buddy";
  flagJP.classList.add("active");
  flagNO.classList.remove("active");
  buildAll();
};

buildAll();
updateStats();

</script>
</body>
</html>
